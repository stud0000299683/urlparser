<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Load Test Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; transition: background 0.3s; }
        .btn:hover { background: #5a67d8; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .input-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status-running { background: #bee3f8; border-left: 4px solid #3182ce; }
        .status-completed { background: #c6f6d5; border-left: 4px solid #38a169; }
        .status-failed { background: #fed7d7; border-left: 4px solid #e53e3e; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #718096; text-transform: uppercase; }
        .chart-container { position: relative; height: 300px; margin: 20px 0; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üöÄ Load Test Dashboard</h1>
        <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è URL Parser</p>
    </div>

    <div class="grid">
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="card">
            <h2>üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>

            <div class="input-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ URL:</label>
                <input type="number" id="urlCount" value="100" min="1" max="1000">
            </div>

            <div class="input-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤:</label>
                <input type="number" id="threadCount" value="20" min="1" max="100">
            </div>

            <div class="input-group">
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫):</label>
                <input type="number" id="duration" value="120" min="10" max="3600">
            </div>

            <div class="input-group">
                <label>–¢–∏–ø —Ç–µ—Å—Ç–∞:</label>
                <select id="testType">
                    <option value="ASYNC">–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (CompletableFuture)</option>
                    <option value="FORKJOIN">ForkJoin Pool</option>
                    <option value="SYNC">–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π</option>
                </select>
            </div>

            <div class="input-group">
                <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º—Å):</label>
                <input type="number" id="interval" value="50" min="0" max="1000">
            </div>

            <button class="btn btn-success" onclick="startCustomTest()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <button class="btn" onclick="quickTest('ASYNC')">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (Async)</button>
            <button class="btn" onclick="quickTest('FORKJOIN')">‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (ForkJoin)</button>
            <button class="btn btn-danger" onclick="stopAllTests()">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
        </div>

        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö -->
        <div class="card">
            <h2>üé≤ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>
            <p>–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ URL –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>

            <div class="input-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ URL –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</label>
                <input type="number" id="generateCount" value="50" min="1" max="500">
            </div>

            <button class="btn" onclick="generateTestUrls()">üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å URL</button>
            <button class="btn" onclick="clearTestData()">üóë –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>

            <div id="generateStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã -->
    <div class="card">
        <h2>üìà –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã</h2>
        <div id="activeTestsList"></div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="statActiveTests">0</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statTotalRequests">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statAvgResponse">0–º—Å</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statErrorRate">0%</div>
                <div class="stat-label">–û—à–∏–±–æ–∫</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="requestsChart"></canvas>
        </div>
    </div>

    <!-- –õ–æ–≥ —Ç–µ—Å—Ç–æ–≤ -->
    <div class="card">
        <h2>üìù –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="testLogs"></div>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:8080';
    let requestsChart = null;
    let updateInterval = null;
    const testLogs = [];
    const requestsData = { labels: [], data: [] };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function initChart() {
        const ctx = document.getElementById('requestsChart').getContext('2d');
        requestsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: requestsData.labels,
                datasets: [{
                    label: '–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É',
                    data: requestsData.data,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'RPS'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–í—Ä–µ–º—è'
                        }
                    }
                }
            }
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function updateStats() {
        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/active`);
            const data = await response.json();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('statActiveTests').textContent = data.activeTests || 0;

            // –°—É–º–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º
            let totalRequests = 0;
            let totalSuccess = 0;
            let totalErrors = 0;
            let avgResponse = 0;

            if (data.tests && Array.isArray(data.tests)) {
                data.tests.forEach(test => {
                    totalRequests += test.totalRequests || 0;
                    totalSuccess += test.successCount || 0;
                    totalErrors += test.errorCount || 0;
                });

                if (data.tests.length > 0) {
                    const lastTest = data.tests[data.tests.length - 1];
                    avgResponse = lastTest.averageResponseTime || 0;
                }
            }

            document.getElementById('statTotalRequests').textContent = totalRequests;
            document.getElementById('statAvgResponse').textContent =
                typeof avgResponse === 'string' ? avgResponse : avgResponse.toFixed(2) + '–º—Å';
            document.getElementById('statErrorRate').textContent =
                totalRequests > 0 ? ((totalErrors * 100) / totalRequests).toFixed(2) + '%' : '0%';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
            updateActiveTestsList(data.tests || []);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            updateChart();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    function updateActiveTestsList(tests) {
        const container = document.getElementById('activeTestsList');

        if (!tests || tests.length === 0) {
            container.innerHTML = '<p class="status">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤</p>';
            return;
        }

        container.innerHTML = tests.map(test => `
            <div class="status status-${test.status.toLowerCase()}">
                <strong>–¢–µ—Å—Ç ID: ${test.testId}</strong>
                <p>–°—Ç–∞—Ç—É—Å: ${test.status}</p>
                <p>–¢–∏–ø: ${test.testType}</p>
                <p>–ó–∞–ø—Ä–æ—Å–æ–≤: ${test.successCount || 0} —É—Å–ø–µ—à–Ω–æ, ${test.errorCount || 0} –æ—à–∏–±–æ–∫</p>
                <p>RPS: ${test.requestsPerSecond || 'N/A'}</p>
                <p>–ó–∞–ø—É—â–µ–Ω: ${new Date(test.startTime).toLocaleTimeString()}</p>
                <button class="btn" onclick="viewTestDetails('${test.testId}')">–î–µ—Ç–∞–ª–∏</button>
            </div>
        `).join('');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    function updateChart() {
        const now = new Date();
        const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É –¥–∞–Ω–Ω—ã—Ö
        requestsData.labels.push(timeLabel);
        requestsData.data.push(Math.floor(Math.random() * 50) + 20); // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫
        if (requestsData.labels.length > 20) {
            requestsData.labels.shift();
            requestsData.data.shift();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
        if (requestsChart) {
            requestsChart.update();
        }
    }

    // –ó–∞–ø—É—Å–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
    async function startCustomTest() {
        const request = {
            urlCount: parseInt(document.getElementById('urlCount').value),
            threadCount: parseInt(document.getElementById('threadCount').value),
            durationSeconds: parseInt(document.getElementById('duration').value),
            testType: document.getElementById('testType').value,
            requestIntervalMs: parseInt(document.getElementById('interval').value),
            generateUrls: true
        };

        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            const result = await response.json();

            if (response.ok) {
                addTestLog(`‚úÖ –¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω: ${result.testId}`);
            } else {
                addTestLog(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
            }

        } catch (error) {
            addTestLog(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    // –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
    async function quickTest(type) {
        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/quick-start?testType=${type}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                addTestLog(`‚úÖ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω (${type}): ${result.testId}`);
            } else {
                addTestLog(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
            }

        } catch (error) {
            addTestLog(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö URL
    async function generateTestUrls() {
        const count = document.getElementById('generateCount').value;
        const statusDiv = document.getElementById('generateStatus');

        statusDiv.innerHTML = '<div class="status status-running">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</div>';

        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/generate-urls?count=${count}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                statusDiv.innerHTML = `<div class="status status-completed">
                    ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${result.generatedCount} URL
                </div>`;
                addTestLog(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${result.generatedCount} —Ç–µ—Å—Ç–æ–≤—ã—Ö URL`);
            } else {
                statusDiv.innerHTML = `<div class="status status-failed">
                    ‚ùå –û—à–∏–±–∫–∞: ${result.error}
                </div>`;
            }

        } catch (error) {
            statusDiv.innerHTML = `<div class="status status-failed">
                ‚ùå –û—à–∏–±–∫–∞: ${error.message}
            </div>`;
        }
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
    async function stopAllTests() {
        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/stop-all`, {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                addTestLog(`üõë –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${result.stoppedCount} —Ç–µ—Å—Ç–æ–≤`);
            }

        } catch (error) {
            addTestLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: ${error.message}`);
        }
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π —Ç–µ—Å—Ç–∞
    async function viewTestDetails(testId) {
        try {
            const response = await fetch(`${BASE_URL}/api/loadtest/status/${testId}`);
            const result = await response.json();

            alert(JSON.stringify(result, null, 2));

        } catch (error) {
            alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function clearTestData() {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ URL?')) {
            addTestLog('üóë –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞
    function addTestLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        testLogs.unshift(`[${timestamp}] ${message}`);

        if (testLogs.length > 10) {
            testLogs.pop();
        }

        const logContainer = document.getElementById('testLogs');
        logContainer.innerHTML = testLogs.map(log => `<p>${log}</p>`).join('');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
        initChart();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        updateInterval = setInterval(updateStats, 3000);

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        updateStats();

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ-–ª–æ–≥–∏
        addTestLog('üöÄ –ü–∞–Ω–µ–ª—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        addTestLog('üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞–º–∏');
    });

    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
</body>
</html>